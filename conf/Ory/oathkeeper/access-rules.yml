# Access Rules for book-looker-realm Oathkeeper
# These rules define how requests are authenticated, authorized, and mutated

# Health check endpoint (no authentication required)
- id: "public:health"
  upstream:
    url: "http://localhost:8080"
  match:
    url: "http://localhost:4455/health"
    methods:
      - GET
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# Ory service endpoints (allow access to admin APIs)
- id: "ory:admin-apis"
  upstream:
    url: "http://localhost:4455"
  match:
    url: "http://localhost:4455/admin/<**>"
    methods:
      - GET
      - POST
      - PUT
      - DELETE
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# OAuth2 token endpoint (for client credentials flow)
- id: "oauth2:token"
  upstream:
    url: "http://hydra:4444"
  match:
    url: "http://localhost:4455/oauth2/token"
    methods:
      - POST
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# OAuth2 introspection endpoint
- id: "oauth2:introspect"
  upstream:
    url: "http://hydra:4445"
  match:
    url: "http://localhost:4455/oauth2/introspect"
    methods:
      - POST
  authenticators:
    - handler: oauth2_introspection
  authorizer:
    handler: allow
  mutators:
    - handler: header
      config:
        headers:
          X-User: "{{ print .Subject }}"

# Default authenticated API endpoints (for future services)
- id: "api:authenticated"
  upstream:
    url: "http://localhost:8080"
  match:
    url: "http://localhost:4455/api/<**>"
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
  authenticators:
    - handler: oauth2_introspection
  authorizer:
    handler: allow
  mutators:
    - handler: header
      config:
        headers:
          X-User-ID: "{{ print .Subject }}"
          X-Token-Scope: "{{ print .Extra.scope }}"

# Fallback rule - deny all other requests for security
- id: "default:deny"
  upstream:
    url: "http://localhost:4455"
  match:
    url: "http://localhost:4455/<**>"
    methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - HEAD
      - OPTIONS
  authenticators:
    - handler: anonymous
  authorizer:
    handler: deny
  mutators:
    - handler: noop
