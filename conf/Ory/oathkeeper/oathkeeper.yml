version: v0.40.6

# Oathkeeper Configuration for book-looker-realm
serve:
  proxy:
    port: 4455
    host: 0.0.0.0
    cors:
      enabled: true
      allowed_origins:
        - "*"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "PATCH"
        - "DELETE"
        - "HEAD"
      allowed_headers:
        - "*"
      exposed_headers:
        - "*"
    tls:
      # Ready for HTTPS when needed
      enabled: false
      cert:
        path: /etc/certs/server.crt
      key:
        path: /etc/certs/server.key
  api:
    port: 4456
    host: 0.0.0.0
    tls:
      enabled: false
      cert:
        path: /etc/certs/server.crt
      key:
        path: /etc/certs/server.key

# HTTP client configuration for upstream service calls
http:
  tls:
    # Force trust of your self-signed CA for upstream HTTPS calls
    verify_certificates: true
    ca_cert_file: /etc/certs/ca.crt
    # Additional security settings
    min_version: "1.2"
    max_version: "1.3"
    # Explicitly disable skip verify (force CA validation)
    insecure_skip_verify: false
  timeout:
    read: 30s
    write: 30s
    idle: 120s
  headers:
    # Default headers for upstream calls
    User-Agent: "Ory-Oathkeeper/0.40.6 book-looker-realm"

log:
  level: debug
  format: json

access_rules:
  matching_strategy: glob
  repositories:
    - file:///etc/config/oathkeeper/access-rules.yml

errors:
  fallback:
    - json
  handlers:
    redirect:
      enabled: true
      config:
        to: http://localhost:3000/login
        when:
          - error:
              - unauthorized
              - forbidden
            request:
              header:
                accept:
                  - text/html
    json:
      enabled: true
      config:
        verbose: true

# Authenticators
authenticators:
  anonymous:
    enabled: true
    config:
      subject: anonymous

  oauth2_introspection:
    enabled: true
    config:
      introspection_url: http://hydra:4445/admin/oauth2/introspect
      scope_strategy: hierarchic
      pre_authorization:
        enabled: true
        client_id: oathkeeper
        client_secret: oathkeeper-secret
        scope: 
          - introspect
        token_url: http://hydra:4444/oauth2/token

  jwt:
    enabled: true
    config:
      # Will be configured later when kerby-instruments is deployed
      jwks_urls: []
      trusted_issuers: []

# Authorizers
authorizers:
  allow:
    enabled: true

  deny:
    enabled: true

  keto_engine_acp_ory:
    enabled: true
    config:
      base_url: http://keto:4466
      required_action: ""
      required_resource: ""
      subject: ""

# Mutators
mutators:
  noop:
    enabled: true

  header:
    enabled: true
    config:
      headers:
        X-User: "{{ print .Subject }}"
        X-Kerberos-Principal: "{{ print .Extra.kerberos_principal }}"
        X-User-Roles: "{{ print .Extra.roles }}"

  id_token:
    enabled: true
    config:
      issuer_url: http://hydra:4444
      jwks_url: http://hydra:4444/.well-known/jwks.json
      ttl: 1h
      claims: |
        {
          "session": {{ .Extra | toJson }}
        }
