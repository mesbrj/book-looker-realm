events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    server {
        listen 80;
        server_name localhost;
        
        # Root directory for PKI files
        root /var/www/html;
        
        # Health check endpoint
        location /health {
            access_log off;
            return 200 "PKI Services OK\n";
            add_header Content-Type text/plain;
        }
        
        # CRL Distribution Points
        location /crl/ {
            alias /var/www/html/certs/crl/;
            
            # Set appropriate headers for CRL files
            add_header Content-Type application/pkix-crl;
            add_header Cache-Control "public, max-age=3600";
            
            # Enable auto-indexing for development
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        
        # CA Certificate Distribution
        location /ca/ {
            alias /var/www/html/certs/;
            
            # Set appropriate headers for certificate files
            location ~ \.(crt|pem)$ {
                add_header Content-Type application/x-x509-ca-cert;
                add_header Cache-Control "public, max-age=86400";
            }
            
            # Enable auto-indexing for development
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }
        
        # OCSP Response proxy (forwards to OCSP responder)
        location /ocsp {
            # Proxy to OCSP responder service
            proxy_pass http://ocsp-responder:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # OCSP specific headers
            add_header Content-Type application/ocsp-response;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Serve static certificate files for direct access
        location /certs/ {
            alias /var/www/html/certs/;
            
            # Enable auto-indexing for development
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
            
            # Security headers
            add_header X-Content-Type-Options nosniff;
            add_header X-Frame-Options DENY;
        }
        
        # Default location
        location / {
            return 200 "PKI Services\n\nAvailable endpoints:\n- /health - Health check\n- /crl/ - Certificate Revocation Lists\n- /ca/ - CA Certificates\n- /ocsp - OCSP Responder\n- /certs/ - Certificate directory\n";
            add_header Content-Type text/plain;
        }
    }
}
